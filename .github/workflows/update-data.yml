name: ðŸ“Š Mise Ã  jour VÃ©loMAG Data

on:
  schedule:
    # Mise Ã  jour 2 fois par jour : 8h et 20h
    - cron: '0 8,20 * * *'
  workflow_dispatch:
    # Permet le dÃ©clenchement manuel
  push:
    branches: [ main ]
    paths:
      - '*.py'
      - 'requirements.txt'

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Installer jq pour parser JSON et bc pour calculs
        sudo apt-get update && sudo apt-get install -y jq bc
        
    - name: ðŸ§ª Verify dependencies
      run: |
        python scripts/check_dependencies.py
        
    - name: ðŸš´â€â™‚ï¸ Generate VÃ©loMAG visualizations
      run: |
        # GÃ©nÃ©rer d'abord les donnÃ©es principales (obligatoire)
        python main.py
        
        # GÃ©nÃ©rer les visualisations interactives (optionnel, en cas d'erreur on continue)
        python interactive_viz.py || echo "âš ï¸ Visualisations interactives Ã©chouÃ©es, mais donnÃ©es principales OK"
        
    - name: ðŸ—‚ï¸ Organize files for GitHub Pages
      run: |
        chmod +x organize_files.sh
        ./organize_files.sh
        
    - name: ðŸ“Š Update README with real stats
      run: |
        # Extraire les statistiques du JSON avec jq
        TOTAL_STATIONS=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_stations')
        TOTAL_BIKES=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_bikes')
        OCCUPATION=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.average_occupancy')
        WORKING_STATIONS=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.working_stations')
        
        # Formater le taux d'occupation en pourcentage
        OCCUPATION_PERCENT=$(echo "$OCCUPATION * 100" | bc -l | cut -d'.' -f1)
        
        # Mettre Ã  jour le README avec les vraies donnÃ©es
        sed -i.bak "s/les \*\*[0-9]* stations VÃ©loMAG\*\*/les **$TOTAL_STATIONS stations VÃ©loMAG**/" README.md
        
        # CrÃ©er une section de statistiques en temps rÃ©el
        echo "" > /tmp/stats_section.md
        echo "## ðŸ“ˆ Statistiques en temps rÃ©el" >> /tmp/stats_section.md
        echo "" >> /tmp/stats_section.md
        echo "> **DerniÃ¨re mise Ã  jour :** \$(date '+%d/%m/%Y Ã  %H:%M UTC')" >> /tmp/stats_section.md
        echo "" >> /tmp/stats_section.md
        echo "| ðŸ“Š MÃ©trique | ðŸ”¢ Valeur | ðŸ“ Description |" >> /tmp/stats_section.md
        echo "|-------------|-----------|----------------|" >> /tmp/stats_section.md
        echo "| ðŸš² **Stations actives** | **$WORKING_STATIONS/$TOTAL_STATIONS** | Stations en fonctionnement |" >> /tmp/stats_section.md
        echo "| ðŸš´â€â™‚ï¸ **VÃ©los disponibles** | **$TOTAL_BIKES** | Total des vÃ©los en circulation |" >> /tmp/stats_section.md
        echo "| ðŸ“ **Taux d'occupation** | **$OCCUPATION_PERCENT%** | Moyenne de toutes les stations |" >> /tmp/stats_section.md
        echo "| ðŸ”„ **Mise Ã  jour** | **2x/jour** | 8h et 20h UTC automatique |" >> /tmp/stats_section.md
        echo "" >> /tmp/stats_section.md
        
        # InsÃ©rer aprÃ¨s la section "AperÃ§u"
        awk '/## ðŸ“Š AperÃ§u/{p=1} /## ðŸŽ¯ DÃ©marrage rapide/{if(p){system("cat /tmp/stats_section.md"); p=0}} 1' README.md > /tmp/readme_updated.md
        mv /tmp/readme_updated.md README.md
        
    - name: ðŸ“Š Update statistics files
      run: |
        # Fichier de mise Ã  jour pour le site
        echo "Last update: $(date)" > docs/last_update.txt
        echo "Total stations: $(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_stations')" >> docs/last_update.txt
        echo "Total bikes: $(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_bikes')" >> docs/last_update.txt
        echo "Working stations: $(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.working_stations')" >> docs/last_update.txt
        
        # Mettre Ã  jour les statistiques dans l'index.html du site
        TOTAL_STATIONS=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_stations')
        TOTAL_BIKES=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.total_bikes')
        OCCUPATION=$(cat docs/data/velomagg_analysis_stats.json | jq -r '.general.average_occupancy')
        OCCUPATION_PERCENT=$(echo "$OCCUPATION * 100" | bc -l | cut -d'.' -f1).$(echo "$OCCUPATION * 100" | bc -l | cut -d'.' -f2 | cut -c1)
        
        # Mise Ã  jour du HTML avec les vraies valeurs
        sed -i.bak "s/<h3 class=\"text-primary mb-1\" id=\"total-stations\">[0-9]*<\/h3>/<h3 class=\"text-primary mb-1\" id=\"total-stations\">$TOTAL_STATIONS<\/h3>/" docs/index.html
        sed -i.bak "s/<h3 class=\"text-success mb-1\" id=\"total-bikes\">[0-9]*<\/h3>/<h3 class=\"text-success mb-1\" id=\"total-bikes\">$TOTAL_BIKES<\/h3>/" docs/index.html
        sed -i.bak "s/<h3 class=\"text-info mb-1\" id=\"occupation-rate\">[0-9.]*%<\/h3>/<h3 class=\"text-info mb-1\" id=\"occupation-rate\">$OCCUPATION_PERCENT%<\/h3>/" docs/index.html
        
    - name: ðŸš€ Deploy to GitHub Pages
      run: |
        # Configuration Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ajouter tous les fichiers du dossier docs
        git add docs/
        
        # Commiter seulement s'il y a des changements
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ”„ Mise Ã  jour automatique des donnÃ©es VÃ©loMAG - $(date)"
          git push origin main
          echo "âœ… DonnÃ©es mises Ã  jour et dÃ©ployÃ©es"
        else
          echo "â„¹ï¸ Aucune modification dÃ©tectÃ©e"
        fi
        
    - name: ðŸ“ Create deployment info
      run: |
        echo "Deployment completed at $(date)" > docs/deployment.log
        echo "Total files: $(find docs/ -type f | wc -l)" >> docs/deployment.log
